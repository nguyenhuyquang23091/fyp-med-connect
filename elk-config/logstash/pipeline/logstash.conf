# Logstash Pipeline Configuration for Med-Connect Logging
# Receives logs from Filebeat and directly from Spring Boot services via TCP

input {
  # Receive logs from Filebeat via Beats protocol
  beats {
    port => 5044
    host => "0.0.0.0"
  }

  # Receive logs directly from Spring Boot services via TCP
  # Used by LogstashTcpSocketAppender in Spring Boot services
  tcp {
    port => 5000
    codec => json_lines
  }
}

filter {
  # Parse JSON logs from Spring Boot services
  json {
    source => "message"
    target => "log"
    skip_on_invalid_json => true
  }

  # If JSON parsing succeeded, promote fields to top level
  if [log] {
    # Copy service field if it exists
    if [log][service] {
      mutate {
        add_field => { "service" => "%{[log][service]}" }
      }
    }

    # Copy application field if it exists
    if [log][application] {
      mutate {
        add_field => { "application" => "%{[log][application]}" }
      }
    }

    # Copy log level if it exists
    if [log][level] {
      mutate {
        add_field => { "log_level" => "%{[log][level]}" }
      }
    }

    # Copy logger name if it exists
    if [log][logger_name] {
      mutate {
        add_field => { "logger_name" => "%{[log][logger_name]}" }
      }
    }

    # Copy thread name if it exists
    if [log][thread_name] {
      mutate {
        add_field => { "thread_name" => "%{[log][thread_name]}" }
      }
    }

    # Copy message to a readable field
    if [log][message] {
      mutate {
        add_field => { "log_message" => "%{[log][message]}" }
      }
    }

    # Handle stack traces
    if [log][stack_trace] {
      mutate {
        add_field => { "stack_trace" => "%{[log][stack_trace]}" }
      }
    }
  }

  # Add environment metadata
  mutate {
    add_field => {
      "environment" => "development"
      "platform" => "med-connect"
    }
  }

  # Parse timestamp from log
  if [log][@timestamp] {
    date {
      match => [ "[log][@timestamp]", "ISO8601" ]
      target => "@timestamp"
    }
  }

  # Set default service name if missing
  if ![service] {
    mutate {
      add_field => { "service" => "unknown-service" }
    }
  }

  # Remove unwanted fields to reduce storage
  mutate {
    remove_field => [ "agent", "ecs", "host", "input", "log" ]
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["https://es01:9200"]
    # Daily indices per service: auth-service-logs-2025.11.21
    index => "%{service}-logs-%{+YYYY.MM.dd}"

    # Authentication (use same credentials as search_service)
    user => "${ELASTICSEARCH_USERNAME}"
    password => "${ELASTICSEARCH_PASSWORD}"

    # SSL settings
    ssl_enabled => true
    ssl_verification_mode => "none"
  }

  # Debug output to console (optional - remove in production)
  stdout {
    codec => rubydebug
  }
}
